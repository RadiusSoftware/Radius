<!DOCTYPE bundle>
<bundle>
    <widget tagname="input-widget">
        <script>
            class InputWidget extends Widget {
                static stdInputTypes = mkStringSet(
                    'color',
                    'date',
                    'datetime-local',
                    'email',
                    'image',
                    'month',
                    'number',
                    'password',
                    'range',
                    'tel',
                    'text',
                    'time',
                    'url',
                    'week',
                );

                constructor(arg) {
                    super(arg);
                }

                buildOptions() {
                    let options = [];

                    if (this.getRdsOptionsKey) {
                        let opts = this.getControllerValue(this.getRdsOptionsKey());
                        
                        if (Objekt.isObjekt(opts)) {
                            for (let value in opts) {
                                options.push({ value: value, text: opts[value] });
                            }
                        }
                    }

                    if (!options.length && this.getInnerElements().length) {
                        for (let htmlElement of this.getInnerElements()) {
                            if (htmlElement.getTagName() == 'opt') {
                                if (htmlElement.hasAttribute('value')) {
                                    let value = htmlElement.getAttribute('value');

                                    if (htmlElement.getRdsShape) {
                                        options.push({
                                            value: value,
                                            shape: htmlElement.getRdsShape(),
                                            text: htmlElement.getInnerHtml().trim(),
                                        });
                                    }
                                    else {
                                        options.push({
                                            value: value,
                                            text: htmlElement.getInnerHtml().trim(),
                                        });
                                    }
                                }
                            }
                        }

                        this.clear();
;                   }

                    if (!options.length && this.getRdsOptions) {
                        let opts = TextUtils.parseAttributeEncoded(this.getRdsOptions());

                        for (let value in opts) {
                            options.push({ value: value, text: opts[value] });
                        }
                    }

                    return options;
                }

                createFieldSet(attributes) {
                    let attrs = this.filterAttributes('design', 'type', 'rds-bind', 'rds-disabled');
                    attrs.design = 'input-widget-radio-fieldset';
                    let fieldset = createElement('fieldset', attrs);
                    let options = this.buildOptions();

                    attrs = {
                        type: 'radio',
                        name: 'UNSPECIFIED',
                        design: 'input-widget-radio',
                    };

                    if (this.getRdsBind) {
                        attrs.name = this.getRdsBind();
                        attrs['rds-bind'] = this.getRdsBind();
                    }

                    if (this.getRdsDisabled) {
                        attrs['rds-disabled'] = this.getRdsDisabled();
                    }

                    let legend;

                    for (let innerElement of this.getInnerElements()) {
                        if (innerElement.getTagName() == 'legend') {
                            legend = innerElement;
                        }
                    }

                    if (legend) {
                        fieldset.prepend(legend);
                    }

                    for (let option of options) {
                        attrs.id = Crypto.generateUUID();
                        attrs.value = option.value;

                        fieldset.append(
                            createElement('div', {
                                design: 'input-widget-radio-div',
                            })
                            .append(
                                createElement('input', attrs),
                                mkHtmlElement('label', {
                                    for: attrs.id,
                                    design: 'input-widget-radio-label',
                                })
                                .setInnerHtml(option.text),
                            )
                        );
                    }

                    return fieldset;
                }

                createSelect(attributes) {
                    attributes.design = 'input-widget-select';
                    let selectElement = createElement('select', attributes);
                    let options = this.buildOptions();

                    let optionElements = options.map(opt => {
                        let optionElement = createElement('option', {
                            value: opt.value,
                            class: 'input-widget-select-option',
                        });

                        let innerOption;

                        if (opt.shape) {
                            innerOption = createElementFromOuterHtml(
                                `<span>${opt.text.trim()}</span>` +
                                `<span class="input-widget-select-option-svg"><svg class="icon icon-small" rds-shape="${opt.shape}"></svg></span>`
                            );
                        }
                        else {
                            innerOption = createElementFromOuterHtml(
                                `<span>${opt.text.trim()}</span>` +
                                `<span class="input-widget-select-option-svg"></span>`
                            );
                        }

                        optionElement.append(...innerOption);
                        return optionElement;
                    });

                    selectElement.append(...optionElements);
                    return selectElement;
                }

                createToggle(attributes) {
                    let bind = '';
                    let disabled = '';

                    if ('rds-bind' in attributes) {
                        bind = ` rds-bind="${attributes['rds-bind']}"`;
                    }

                    if ('rds-disabled' in attributes) {
                        disabled = ` rds-disabled="${attributes['rds-disabled']}"`;
                    }

                    let toggle = createElementFromOuterHtml(
                        `<span${disabled}>
                            <input type="checkbox"${bind} style="display:none;">
                            <svg rds-shape="circle"></svg>
                        </span>`
                    );

                    const knob = toggle.getChildElementAt(1);
                    const checkbox = toggle.getChildElementAt(0);

                    const update = () => {
                        if (checkbox.getProperty('checked')) {
                            knob.setAttribute('design', 'input-widget-toggle-knob-selected');
                            toggle.setAttribute('design', 'input-widget-toggle-selected');
                        }
                        else {
                            knob.setAttribute('design', 'input-widget-toggle-knob-unselected');
                            toggle.setAttribute('design', 'input-widget-toggle-unselected');
                        }

                        if (!toggle.hasAttribute('disabled')) {
                            toggle.clearStyle();
                        }
                        else {
                            toggle.setStyle({
                                opacity: .5,
                                cursor: 'default',
                            });
                        }
                    }

                    setTimeout(() => update(), 0);
                    let controller = this.getController();

                    if (controller) {
                        let objekt = controller.getObjekt();

                        if (objekt) {
                            objekt.on('Update', message => {
                                if ('rds-bind' in attributes && message.key == attributes['rds-bind']) {
                                    update();
                                }
                                else if ('rds-disabled' in attributes && message.key == attributes['rds-disabled']) {
                                    update();
                                }
                            });
                        }
                    }

                    toggle.on('click', message => {
                        if (!toggle.hasAttribute('disabled')) {
                            checkbox.node.click();
                        }
                    });

                    return toggle;
                }
 
                init() {
                    let attributes = this.filterAttributes('design', 'type');

                    if (this.hasAttribute('type')) {
                        let editor;
                        let type = this.getAttribute('type');

                        if (InputWidget.stdInputTypes.has(type)) {
                            attributes.type = type;
                            attributes.design = 'input-widget-input';
                            editor = createElement('input', attributes);
                        }
                        else if (type in { button:0, submit:0 }) {
                            attributes.type = type;
                            attributes.design = 'input-widget-button';
                            editor = createElement('input', attributes);
                        }
                        else if (type == 'checkbox') {
                            attributes.type = type;
                            attributes.design = 'input-widget-checkbox';
                            editor = createElement('input', attributes);
                        }
                        else if (type == 'essay') {
                            attributes.design = 'input-widget-essay';
                            editor = createElement('textarea', attributes);
                        }
                        else if (type == 'fieldset') {
                            editor = this.createFieldSet(attributes);
                        }
                        else if (type == 'select') {
                            editor = this.createSelect(attributes);
                            editor.once('focusin', message => InputWidget.layoutSelect(editor));
                        }
                        else if (type == 'submit') {
                            attributes.design = 'input-widget-button';
                            editor = createElement('submit', attributes);
                        }
                        else if (type == 'toggle') {
                            editor = this.createToggle(attributes);
                        }
                        else {
                            attributes.type = 'text';
                            attributes.design = 'input-widget-input';
                            editor = createElement('input', attributes);
                        }

                        this.replace(editor);
                    }
                }

                static layoutSelect(select) {
                    let maxWidth = 0;
                    let hasSvg = false;

                    for (let option of select.getChildElements()) {
                        let text = option.getChildElementAt(0);
                        let svg = option.getChildElementAt(1);
                        
                        if (text.getClientWidth() > maxWidth) {
                            maxWidth = text.getClientWidth();
                        }

                        if (svg.getChildElements().length) {
                            hasSvg = true;
                        }
                    }

                    for (let option of select.getChildElements()) {
                        option.getChildElementAt(0).setStyle({ width: `${maxWidth+10}px` });
                    }

                    if (!hasSvg) {
                        for (let option of select.getChildElements()) {
                            option.getChildElementAt(1).setStyle({ width: '0px' });
                        }
                    }
                }
            }
        </script>
        <style>
            [design=button] {
                height: 48px;
                margin-top: 6px;
                margin-bottom: 6px;
                padding-left: 4px;
                padding-right: 4px;
                padding-top: 6px;
                padding-bottom: 6px;
                border-color: var(--border-color);
                border-width: 1px;
                border-style: solid;
                border-radius: var(--border-radius-1);
                outline: none;
                color: var(--button-color);
                background-color: var(--button-background-color);
                font-size: 16px;
                cursor: pointer;
                transition-property: background-color;
                transition-duration: .5s;
            }
            [design=button]:focus {
                color: var(--hover-color);
                border-color: var(--hover-border-color);
                outline-color: var(--hover-border-color);
                outline-style: solid;
                outline-width: 3px;
            }
            [design=button]:hover {
                color: var(--hover-color);
                background-color: var(--button-hover-background-color);
            }
            [design=button]:disabled {
                color: var(--hover-color);
                background-color: var(--disabled-button-color);
                cursor: default;
            }
            [design=checkbox] {
                appearance: none;
                width: 32px;
                height: 32px;
                margin: 0px;
                padding: 0px;
                background-color: var(--label-background-color);
                border-color: var(--faint-border-color);
                border-width: 1px;
                border-style: solid;
                border-radius: var(--border-radius-1);
                cursor: pointer;

            }
            [design=checkbox]::after {
                margin-left: 4px;
                margin-bottom: 4px;
                content: "✓";
                font-size: 28px;
                font-family: Arial, Helvetica, sans-serif;
                color: var(--label-background-color);

            }
            [design=checkbox]:checked::after {
                margin-left: 4px;
                margin-bottom: 4px;
                content: "✓";
                font-size: 28px;
                font-family: Arial, Helvetica, sans-serif;
                color: var(--checked-color);
            }
            [design=checkbox]:hover {
                outline-color: var(--hover-border-color);
                outline-style: solid;
                outline-width: 3px;
            }
            [design=checkbox]:focus {
                outline-color: var(--hover-border-color);
                outline-style: solid;
                outline-width: 3px;
            }
            [design=checkbox]:disabled {
                opacity: .4;
                cursor: default;
            }
            [design=essay] {
                margin-top: 6px;
                margin-bottom: 6px;
                padding-left: 4px;
                padding-right: 4px;
                padding-top: 6px;
                padding-bottom: 6px;
                border-color: var(--border-color);
                border-width: 1px;
                border-style: solid;
                border-radius: var(--border-radius-1);
                outline: none;
                color: var(--color);
                background-color: var(--textarea-background-color);
            }
            [design=essay]:focus {
                border-color: var(--hover-border-color);
                outline-color: var(--hover-border-color);
                outline-style: solid;
                outline-width: 3px;
                color: var(--hover-color);
                background-color: var(--hover-background-color);
            }
            [design=essay]:hover {
                color: var(--hover-color);
                background-color: var(--hover-background-color);
            }
            [design=essay]:invalid {
                border-color: var(--error-color);
                outline-color: var(--error-color);
            }
            [design=input] {
                display: flex;
                align-items: center;
                height: 40px;
                margin-top: 6px;
                margin-bottom: 6px;
                margin-left: 0px;
                margin-right: 0px;
                padding-top: 4px;
                padding-bottom: 4px;
                border-style: solid;
                border-color: var(--border-color);
                border-width: 1px;
                border-radius: var(--border-radius-1);
                font-size: 16px;
                color: var(--color);
                background-color: var(--background-color);
                outline: none;
            }
            [design=input]:-webkit-autofill {
                -webkit-text-fill-color: var(--color);
                box-shadow: 0 0 0 30px var(--background-color) inset !important;
                -webkit-box-shadow: 0 0 0 30px var(--background-color) inset !important;

            }
            [design=input]:focus {
                border-color: var(--hover-border-color);
                outline-color: var(--hover-border-color);
                outline-style: solid;
                outline-width: 3px;
                color: var(--button-color);
                background-color: var(--background-color);
            }
            [design=input]:hover {
                -webkit-text-fill-color: var(--hover-color);
                box-shadow: 0 0 0 30px var(--hover-background-color) inset !important;
                -webkit-box-shadow: 0 0 0 30px var(--hover-background-color) inset !important;

            }
            [design=input]:invalid {
                border-color: var(--error-color);
                outline-color: var(--error-color);
            }
            [design=radio] {
                appearance: none;
                content: "";
                width: var(--radio-radius);
                height: var(--radio-radius);
                margin-left: 6px;
                margin-right: 8px;
                padding: 0px;
                background-color: var(--label-background-color);
                border-color: var(--faint-border-color);
                border-width: 1px;
                border-style: solid;
                border-radius:  var(--radio-radius);
                cursor: pointer;

            }
            [design=radio]::after {
                margin-left: 4px;
                margin-bottom: 4px;
                content: "✓";
                font-size: 26px;
                font-family: Arial, Helvetica, sans-serif;
                color: var(--label-background-color);

            }
            [design=radio]:checked::after {
                margin-left: 4px;
                margin-bottom: 4px;
                content: "✓";
                font-size: 26px;
                font-family: Arial, Helvetica, sans-serif;
                color: var(--checked-color);
            }
            [design=radio]:hover {
                outline-color: var(--hover-border-color);
                outline-style: solid;
                outline-width: 3px;
            }
            [design=radio]:focus {
                outline-color: var(--hover-border-color);
                outline-style: solid;
                outline-width: 3px;
            }
            [design=radio]:disabled {
                opacity: .4;
                cursor: default;
            }
            [design=radio-div] {
                margin-top: 6px;
                margin-bottom: 6px;
            }
            [design=radio-fieldset] {
                margin-top: 6px;
                margin-bottom: 6px;
                border-color: var(--border-color);
                border-width: 1px;
                border-style: solid;
                border-radius: var(--border-radius-2);
            }
            [design=radio-lengnd] {
                font-size: 14px;
            }
            [design=select] {
                display: flex;
                align-items: center;
                height: 40px;
                margin-top: 6px;
                margin-bottom: 6px;
                margin-left: 0px;
                margin-right: 0px;
                padding-top: 4px;
                padding-bottom: 4px;
                border-style: solid;
                border-color: var(--border-color);
                border-width: 1px;
                border-radius: var(--border-radius-1);
                font-size: 16px;
                color: var(--color);
                background-color: var(--textarea-background-color);
                vertical-align: middle;
                appearance: base-select;
            }
            [design=select]:hover {
                border-color: var(--hover-border-color);
                outline-color: var(--hover-border-color);
                outline-style: solid;
                outline-width: 3px;
                color: var(--hover-color);
                background-color: var(--hover-background-color);
                cursor: pointer;
            }
            [design=select]:focus {
                border-color: var(--hover-border-color);
                outline-color: var(--hover-border-color);
                outline-style: solid;
                outline-width: 3px;
                color: var(--hover-color);
                background-color: var(--hover-background-color);
                cursor: pointer;
            }
            ::picker(select) {
                padding-top: 12px;
                padding-bottom: 12px;
                padding-left: 12px;
                padding-right: 12px;
                border-style: solid;
                border-color: var(--border-color);
                border-width: 1px;
                border-radius: var(--border-radius-1);
                background-color: var(--textarea-background-color);
                appearance: base-select;
            }
            .input-widget-select-option {
                color: var(--color);
                background-color: var(--textarea-background-color);
                font-size: 16px;
            }
            .input-widget-select-option::checkmark {
                order: 1;
            }
            .input-widget-select-option:checked {
                color: var(--hover-color);
            }
            .input-widget-select-option:hover {
                color: var(--hover-color);
                background-color: var(--hover-background-color);
                cursor: pointer;
            }
            .input-widget-select-option-svg {
                width: 32px;
            }
            [design=toggle-unselected] {
                display: inline-block;
                user-select: none;
                width: 80px;
                height: 24px;
                margin: 0px;
                padding: 0px;
                background-color: var(--toggle-unselected-background-color);
                border-color: var(--border-color);
                border-width: 1px;
                border-style: solid;
                border-radius: var(--border-radius-2);
                cursor: pointer;
                transition-delay: .45s;
            }
            [design=toggle-selected] {
                display: inline-block;
                user-select: none;
                width: 80px;
                height: 24px;
                margin: 0px;
                padding: 0px;
                background-color: var(--toggle-selected-background-color);
                border-color: var(--border-color);
                border-width: 1px;
                border-style: solid;
                border-radius: var(--border-radius-2);
                cursor: pointer;
                transition-delay: .45s;
            }
            [design=toggle-knob-unselected] {
                width: 20px;
                height: 20px;
                margin-top: 2px;
                margin-bottom: 0px;
                margin-left: 2px;
                margin-right: 0px;
                fill: var(--knob-fill-color);
                stroke: var(--knob-stroke-color);
                transition-duration: .45s;
            }
            [design=toggle-knob-selected] {
                width: 20px;
                height: 20px;
                margin-top: 2px;
                margin-bottom: 0px;
                margin-left: 58px;
                margin-right: 0px;
                fill: var(--knob-fill-color);
                stroke: var(--knob-stroke-color);
                transition-duration: .45s;
            }
        </style>
    </widget>
    <!-- **************************************************************************************************** -->
    <!-- **************************************************************************************************** -->
    <widget tagname="file-widget">
        <script>
            class FileWidget extends Widget {
                constructor(arg) {
                    super(arg);
                }
            }
        </script>
    </widget>
    <!-- **************************************************************************************************** -->
    <!-- **************************************************************************************************** -->
    <widget tagname="busy-widget">
        <script>
            class BusyWidget extends Widget {
                constructor(arg) {
                    super(arg);
                }
            }
        </script>
    </widget>
    <!-- **************************************************************************************************** -->
    <!-- **************************************************************************************************** -->
    <widget tagname="progress-widget">
        <script>
            class ProgressWidget extends Widget {
                constructor(arg) {
                    super(arg);
                }
            }
        </script>
    </widget>
    <!-- **************************************************************************************************** -->
    <!-- **************************************************************************************************** -->
    <widget tagname="dataeditor-widget">
        <script>
            class DataEditorWidget extends Widget {
                constructor(arg) {
                    super(arg);
                }

                getMeta(key) {
                    let meta = {
                        key: key,
                        value: this.getControllerValue(key),
                    };

                    if (this.fields) {
                        if (Objekt.isObjekt(meta.value)) {
                            if (meta.value.isArray()) {
                                meta.type = ArrayType;
                            }
                            else {
                                meta.type = ObjectType;
                                meta.fields = [];

                                for (let field of this.fields) {
                                    for (let key in meta.value) {
                                        let subkey = `${meta.key}.${key}`;

                                        if (subkey.match(field.regex)) {
                                            if (field.hidden !== true) {
                                                meta.fields.push({
                                                    type: getJsType(meta.value[subkey]),
                                                    property: key,
                                                    key: subkey,
                                                    label: field.label ? field.label : key,
                                                });

                                                break;
                                            }
                                        }
                                    }
                                }

                                if (meta.fields.length) {
                                    return meta;
                                }
                            }
                        }
                        else {
                            meta.type = getJsType(meta.value);

                            for (let field of this.fields) {
                                if (key.match(field.regex)) {
                                    break;
                                }
                            }
                        }
                    }
                    
                    meta.readonly = true;

                    if (Objekt.isObjekt(meta.value)) {
                        if (meta.value.isArray()) {
                            meta.type = ArrayType;
                        }
                        else {
                            meta.type = ObjectType;

                            meta.fields = Object.keys(meta.value).map(property => {
                                return {
                                    type: getJsType(meta.value[property]),
                                    property: property,
                                    key: `${key}.${property}`,
                                    label: property,
                                }
                            });
                        }
                    }
                    else {
                        meta.type = getJsType(meta.value);
                    }

                    return meta;
                }

                init() {
                    if (this.getRdsBind) {
                        this.key = this.getRdsBind();
                        delete this.getRdsBind;
                    }
                    else {
                        return;
                    }

                    super.init();
                    this.fields = this.getPinned('fields');

                    if (this.fields) {
                        for (let field of this.fields) {
                            field.regex = new RegExp(`${field.tail}$`);
                        }
                    }

                    let surface = this.renderValue(this.key, false);

                    if (surface) {
                        this.append(surface);
                    }
                }

                onEdit(message) {
                    console.log(message);
                }

                renderArray(meta, readonly) {
                    let div = createElement('div');

                    for (let i in meta.value) {
                        let subkey = `${meta.key}.${i}`;
                        let surface = this.renderValue(subkey, readonly || meta.readonly);

                        if (surface) {
                            div.append(surface);
                        }
                    }

                    if (!readonly && !meta.readonly) {
                        // *********************************************************************
                        // *********************************************************************
                        console.log(`ARRAY is editable: ${meta.key}`);
                    }

                    return div;
                }
                
                renderObject(meta, readonly) {
                    let div = createElementFromOuterHtml('<div design="dataeditor-widget-object"></div>');
                    let table = createElement('table-widget').setColumnCount(2);

                    for (let field of meta.fields) {
                        if (field.property in meta.value) {
                            let surface = this.renderValue(field.key, !readonly && !meta.readonly );

                            if (surface) {
                                table.appendRow([
                                    {
                                        content: field.label,
                                        style: 'color:var(--label-color);',
                                    },
                                    {
                                        content: surface
                                    }
                                ]);
                            }
                        }
                    }

                    if (!readonly && !meta.readonly) {
                        // *********************************************************************
                        // *********************************************************************
                        console.log(`OBJECT is editable: ${meta.key}`);
                    }

                    div.append(table);
                    return div;
                }

                renderScalar(meta, readonly) {
                    let options;

                    if (StringType.verify(meta.value)) {
                        options = {
                            design: 'dataeditor-widget-content',
                            class: 'dataeditor-widget-string',
                            'rds-bind': meta.key,
                            'rds-meta': meta,
                        };
                    }
                    else if (NumberType.verify(meta.value)) {
                        options = {
                            design: 'dataeditor-widget-content',
                            class: 'dataeditor-widget-number',
                            'rds-bind': meta.key,
                            'rds-meta': meta,
                        };
                    }
                    else if (BooleanType.verify(meta.value)) {
                        options = {
                            design: 'dataeditor-widget-content',
                            class: 'dataeditor-widget-boolean',
                            'rds-bind': meta.key,
                            'rds-meta': meta,
                        };
                    }
                    else if (DateType.verify(meta.value)) {
                        options = {
                            design: 'dataeditor-widget-content',
                            class: 'dataeditor-widget-boolean',
                            'rds-bind': meta.key,
                            'rds-meta': meta,
                        };
                    }
                    else if (PatternType.verify(value)) {
                        options = {
                            design: 'dataeditor-widget-content',
                            class: 'dataeditor-widget-regex',
                            'rds-bind': meta.key,
                            'rds-meta': meta,
                        };
                    }
                    else {
                        options = {
                            design: '"dataeditor-widget-content"',
                            class: 'dataeditor-widget-other',
                            'rds-bind': meta.key,
                            'rds-meta': meta,
                        };
                    }

                    if (!readonly && !meta.readonly) {
                        options['evt-click'] = 'edit';
                        options.class = `${options.class} dataeditor-widget-editable`;
                    }

                    return createElement('div', options);
                }

                renderValue(key, readonly) {
                    let meta = this.getMeta(key);

                    if (meta.type === ArrayType) {
                        return this.renderArray(meta, readonly); 
                    }
                    else if (meta.type === ObjectType) {
                        return this.renderObject(meta, readonly);
                    }
                    else {
                        return this.renderScalar(meta, readonly);
                    }
                }
            }
        </script>
        <style>
            [design=content] {
                margin: 0px;
                padding: 0px;
                font-family: 'Courier New', Courier, monospace;
                font-size: 16px;
            }
            [design=object] {
                display: block;
                margin-top: 6px;
                margin-bottom: 6px;
                margin-left: 0px;
                margin-right: 0px;
                padding: 0px;
                font-family: 'Courier New', Courier, monospace;
                font-size: 16px;
                border: 1px solid var(--faint-border-color);
            }
            .dataeditor-widget-string {
                color: var(--value-string-color);
            }
            .dataeditor-widget-number {
                color: var(--value-number-color);
            }
            .dataeditor-widget-boolean {
                color: var(--value-boolean-color);
            }
            .dataeditor-widget-date {
                color: var(--value-date-color);
            }
            .dataeditor-widget-regex {
                color: var(--value-regex-color);
            }
            .dataeditor-widget-other {
                color: var(--value-other-color);
            }
            .dataeditor-widget-editable {
                cursor: pointer;
            }
            .dataeditor-widget-editable:hover {
                color: var(--hover-color);
                outline: 1px solid var(--hover-border-color);
            }
        </style>
    </widget>
    <strings lang="en">
    </strings>
</bundle>